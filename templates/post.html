{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="question-container">
   <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–æ–ø—Ä–æ—Å–∞ -->
   <h1 class="question-title">{{ question.title }}</h1>

   <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–æ–ø—Ä–æ—Å–µ -->
   <div class="question-content">
       <!-- –ê–≤–∞—Ç–∞—Ä –∞–≤—Ç–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–∞ -->
       <div class="question-author">
           <img src="{% if question.author.profile.avatar_path %}{% static question.author.profile.avatar_path %}{% else %}{% static 'img/profile.png' %}{% endif %}"
                alt="Avatar"
                class="avatar">
           <span class="author-name">{{ question.author.username }}</span>
       </div>

       <!-- –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ -->
       <div class="question-text">
           {{ question.text }}
       </div>

       <!-- –õ–∞–π–∫–∏ –∏ —Ç–µ–≥–∏ -->
       <div class="question-meta">
           <div class="likes">
               <button class="like-button" data-question-id="{{ question.id }}" data-action="like">üëç</button>
               <span class="count">{{ question.likes.count }}</span>
           </div>

           <div class="tags">
               {% for tag in question.tags.all %}
                   <a href="{% url 'tag_questions' tag.name %}" class="tag">{{ tag.name }}</a>
               {% empty %}
                   <span class="tag">No tags</span>
               {% endfor %}
           </div>
       </div>
   </div>

   <!-- –û—Ç–≤–µ—Ç—ã -->
   <div class="answers-container">
       <h2 class="answers-title">Answers ({{ question.answers.count }})</h2>

       {% for answer in answers %}
           <div class="answer">
               <!-- –ê–≤–∞—Ç–∞—Ä –∞–≤—Ç–æ—Ä–∞ –æ—Ç–≤–µ—Ç–∞ -->
               <div class="answer-author">
                   <img src="{% if answer.author.profile.avatar_path %}{% static answer.author.profile.avatar_path %}{% else %}{% static 'img/profile.png' %}{% endif %}"
                        alt="Avatar"
                        class="avatar">
                   <span class="author-name">{{ answer.author.username }}</span>
               </div>

               <!-- –¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ -->
               <div class="answer-text">
                   {{ answer.text }}
               </div>

               <!-- –õ–∞–π–∫–∏ –æ—Ç–≤–µ—Ç–∞ -->
               <div class="answer-likes">
                   <button class="like-answer-button" data-answer-id="{{ answer.id }}" data-action="like">üëç</button>
                   <span class="count">{{ answer.likes.count }}</span>
               </div>

               <!-- –ì–∞–ª–æ—á–∫–∞ "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç" -->
               {% if question.author == request.user %}
                   <button class="correct-answer-button" data-question-id="{{ question.id }}" data-answer-id="{{ answer.id }}">‚úÖ</button>
               {% endif %}
           </div>
       {% empty %}
           <p class="no-answers">No answers yet. Be the first to answer!</p>
       {% endfor %}
   </div>

   <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ -->
   <div class="add-answer">
       <h2>Add an Answer</h2>
       <form method="post">
           {% csrf_token %}
           {{ form.as_p }}
           <button type="submit" class="submit-button">Submit</button>
       </form>
   </div>
</div>

<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ª–∞–π–∫–æ–≤ –≤–æ–ø—Ä–æ—Å–∞ -->
<script>
$(document).ready(function() {
   $('.like-button').click(function() {
       const button = $(this);
       const questionId = button.data('question-id');
       const action = button.data('action');
       const url = "{% url 'like_question' %}";

       $.ajax({
           url: url,
           type: 'POST',
           data: {
               'question_id': questionId,
               'action': action,
               'csrfmiddlewaretoken': '{{ csrf_token }}'
           },
           success: function(response) {
               if (response.status === 'ok') {
                   button.siblings('.count').text(response.likes_count);
               } else {
                   alert(response.message);
               }
           }
       });
   });
});
</script>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ -->
<script>
$(document).ready(function() {
   $('.correct-answer-button').click(function() {
       const button = $(this);
       const questionId = button.data('question-id');
       const answerId = button.data('answer-id');
       const url = "{% url 'mark_correct_answer' %}";

       $.ajax({
           url: url,
           type: 'POST',
           data: {
               'question_id': questionId,
               'answer_id': answerId,
               'csrfmiddlewaretoken': '{{ csrf_token }}'
           },
           success: function(response) {
               if (response.status === 'ok') {
                   alert('Answer marked as correct!');
               } else {
                   alert(response.message);
               }
           }
       });
   });
});
</script>
{% endblock %}